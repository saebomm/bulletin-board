<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:fragment="layout(content)">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Saebom Board</title>
    <link rel="stylesheet" th:href="@{/css/bulletin.css}">
</head>
<body class="bb-body">

<div class="bb-layout">

    <!-- Sidebar -->
    <aside class="bb-sidebar">

        <!-- 로그인 상태: 사이드바 상단 회원 카드 -->
        <div class="bb-sidebar__user-card"
             th:if="${loginMember != null}"
             th:with="
                roleText=${loginMember.admin ? '관리자' : '일반 회원'}
             ">

            <div class="bb-sidebar__user-main">
                <div class="bb-sidebar__user-avatar"
                     th:text="${#strings.substring(loginMember.name, 0, 1)}">
                </div>

                <div class="bb-sidebar__user-texts">

                    <!-- 이름 + 뱃지 묶는 그룹 -->
                    <div class="bb-sidebar__name-group">
                        <div class="bb-sidebar__user-name"
                             th:text="${loginMember.name}">
                        </div>

                        <!-- 뱃지: ROLE에 따라 -->
                        <span class="bb-role-badge"
                              th:classappend="${loginMember.admin} ? ' bb-role-badge--admin' : ''"
                              th:text="${roleText}">
                        </span>
                    </div>

                    <div class="bb-sidebar__user-meta"
                         th:text="${loginMember.username}">
                    </div>
                </div>
            </div>

            <div class="bb-sidebar__user-inline bb-sidebar__user-inline--spaced bb-sidebar__user-inline--center">
                <a href="/members/me" class="bb-sidebar__inline-btn">MyPage</a>

                <form action="/logout" method="post" style="margin:0;">
                    <input type="hidden" name="redirectURL" value="/articles">
                    <button type="submit" class="bb-sidebar__inline-btn bb-sidebar__inline-btn--logout">
                        로그아웃
                    </button>
                </form>
            </div>
        </div>

        <!-- 비로그인 상태: 게스트 카드 -->
        <div class="bb-sidebar__user-card"
             th:if="${loginMember == null}">

            <div class="bb-sidebar__user-main">
                <div class="bb-sidebar__user-avatar">G</div>
                <div class="bb-sidebar__user-texts">
                    <div class="bb-sidebar__user-name">게스트</div>
                    <div class="bb-sidebar__user-meta">
                        게시글 작성은 로그인 후 이용할 수 있어요.
                    </div>
                </div>
            </div>

            <div class="bb-sidebar__user-inline bb-sidebar__user-inline--center">
                <a th:href="@{/login}" class="bb-sidebar__inline-btn">로그인</a>
                <a th:href="@{/members/new}"
                   class="bb-sidebar__inline-btn bb-sidebar__inline-btn--outline">
                    회원가입
                </a>
            </div>
        </div>

        <!-- Nav: active 처리 + Admin 메뉴 권한 분기 -->
        <nav class="bb-sidebar__nav" th:with="path=${currentPath}">

            <!-- Public / Common -->
            <div class="bb-sidebar__nav-title">Menu</div>

            <a th:href="@{/articles}"
               class="bb-sidebar__link"
               th:classappend="${#strings.startsWith(path, '/articles') and !#strings.startsWith(path, '/articles/my')} ? ' bb-sidebar__link--active' : ''">
                <span class="bb-sidebar__link-icon">◆</span>
                <span>전체 게시글</span>
            </a>

            <!-- 내가 쓴 글 (로그인 시만) -->
            <a th:if="${loginMember != null}"
               th:href="@{/articles/my}"
               class="bb-sidebar__link"
               th:classappend="${#strings.startsWith(path, '/articles/my')} ? ' bb-sidebar__link--active' : ''">
                <span class="bb-sidebar__link-icon">✎</span>
                <span>내가 쓴 글</span>
            </a>

            <!-- Admin -->
            <div th:if="${loginMember != null and loginMember.admin}">
                <div class="bb-sidebar__nav-title" style="margin-top:14px;">Admin</div>

                <a th:href="@{/admin/articles}"
                   class="bb-sidebar__link"
                   th:classappend="${#strings.startsWith(path, '/admin/articles')} ? ' bb-sidebar__link--active' : ''">
                    <span class="bb-sidebar__link-icon">▣</span>
                    <span>게시글 관리</span>
                </a>

                <a th:href="@{/admin/members}"
                   class="bb-sidebar__link"
                   th:classappend="${#strings.startsWith(path, '/admin/members')} ? ' bb-sidebar__link--active' : ''">
                    <span class="bb-sidebar__link-icon">◎</span>
                    <span>회원 관리</span>
                </a>
            </div>

        </nav>

        <div class="bb-sidebar__footer">
            <div>spring-dev-journey</div>
            <div>bulletin-board · MyBatis</div>
        </div>
    </aside>

    <!-- 모바일에서 사이드바 열렸을 때 덮는 배경 -->
    <div class="bb-sidebar-backdrop" id="sidebar-backdrop"></div>

    <!-- Main -->
    <div class="bb-main">

        <!-- Header -->
        <header class="bb-header">
            <div class="bb-header__title-group">

                <!-- 모바일 메뉴 버튼 -->
                <button type="button"
                        class="bb-header__menu-btn"
                        id="sidebar-toggle"
                        aria-label="메뉴 열기">
                    <span class="bb-header__menu-icon"></span>
                </button>

                <!-- 로고 -->
                <a th:href="@{/articles}" class="bb-header__brand-link">
                    <img th:src="@{/img/logo-saebom-board.svg}"
                         alt="Saebom Board"
                         class="bb-header__logo-img">
                </a>

            </div>

            <div class="bb-header__right">
                <div class="bb-header__pill">
                    v1.0 · Practice Project
                </div>
            </div>
        </header>

        <!-- Content -->
        <main class="bb-content">
            <!-- Toast Messages (공통) -->
            <div class="bb-toast-area"
                 th:if="${successMessage != null or errorMessage != null}">

                <div th:if="${successMessage}"
                     class="bb-toast bb-toast--success"
                     data-auto-dismiss="3000">
                    <div class="bb-toast__icon">✓</div>
                    <div class="bb-toast__body">
                        <p class="bb-toast__title">완료</p>
                        <p class="bb-toast__msg" th:text="${successMessage}">성공 메시지</p>
                    </div>
                    <button type="button" class="bb-toast__close" aria-label="닫기">×</button>
                </div>

                <div th:if="${errorMessage}"
                     class="bb-toast bb-toast--danger"
                     data-auto-dismiss="4500">
                    <div class="bb-toast__icon">!</div>
                    <div class="bb-toast__body">
                        <p class="bb-toast__title">오류</p>
                        <p class="bb-toast__msg" th:text="${errorMessage}">에러 메시지</p>
                    </div>
                    <button type="button" class="bb-toast__close" aria-label="닫기">×</button>
                </div>

            </div>

            <section th:insert="${content}"></section>
        </main>

    </div>

</div>

<script th:inline="javascript">
    (function () {
        /* ===========================
           Sidebar Toggle
        =========================== */

        const sidebar = document.querySelector('.bb-sidebar');
        const toggleBtn = document.getElementById('sidebar-toggle');
        const backdrop = document.getElementById('sidebar-backdrop');
        const body = document.body;

        function openSidebar() {
            sidebar.classList.add('bb-sidebar--open');
            if (backdrop) {
                backdrop.classList.add('bb-sidebar-backdrop--visible');
                backdrop.style.display = 'block';
            }
            body.classList.add('bb-body--no-scroll');
        }

        function closeSidebar() {
            sidebar.classList.remove('bb-sidebar--open');
            if (backdrop) {
                backdrop.classList.remove('bb-sidebar-backdrop--visible');
                setTimeout(() => { backdrop.style.display = 'none'; }, 200);
            }
            body.classList.remove('bb-body--no-scroll');
        }

        if (sidebar && toggleBtn) {
            toggleBtn.addEventListener('click', function () {
                const isOpen = sidebar.classList.contains('bb-sidebar--open');
                isOpen ? closeSidebar() : openSidebar();
            });
        }

        if (backdrop) {
            backdrop.addEventListener('click', closeSidebar);
        }

        /* ===========================
           Toast Auto Dismiss
        =========================== */

        const toasts = document.querySelectorAll('.bb-toast');
        if (!toasts || toasts.length === 0) return;

        function hideToast(toast) {
            if (!toast || toast.classList.contains('bb-toast--hide')) return;
            toast.classList.add('bb-toast--hide');

            setTimeout(() => {
                toast.remove();
                const area = document.querySelector('.bb-toast-area');
                if (area && area.children.length === 0) {
                    area.remove();
                }
            }, 220);
        }

        toasts.forEach((toast) => {
            const closeBtn = toast.querySelector('.bb-toast__close');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => hideToast(toast));
            }

            const ms = Number(toast.getAttribute('data-auto-dismiss') || '0');
            if (ms > 0) {
                setTimeout(() => hideToast(toast), ms);
            }
        });
    })();
</script>

</body>
</html>